<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Calificaciones</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2rem;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }

    .form-grupo {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-consultar {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-consultar:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-consultar:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .resultado {
      display: none;
    }

    .info-alumno {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .info-header {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .info-header h2 {
      margin: 0 0 10px 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
    }

    .info-item strong {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 3px;
    }

    .seccion {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .seccion h3 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .materia-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .materia-card h4 {
      color: #333;
      margin: 0 0 10px 0;
    }

    .materia-info {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .calificaciones-list {
      background: white;
      padding: 15px;
      border-radius: 8px;
    }

    .calificacion-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .calificacion-item:last-child {
      border-bottom: none;
    }

    .calificacion-valor {
      font-weight: bold;
      color: #4caf50;
      font-size: 1.2rem;
    }

    .sin-datos {
      text-align: center;
      padding: 30px;
      color: #999;
      font-style: italic;
    }

    .btn-nuevo {
      background: #f5f5f5;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-block;
      text-align: center;
      margin-top: 20px;
    }

    .btn-nuevo:hover {
      background: #667eea;
      color: white;
    }

    .btn-horario {
      background: #e0e0e0;
      color: #666;
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      cursor: not-allowed;
      font-weight: 600;
      margin-top: 20px;
      display: inline-block;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- FORMULARIO DE CONSULTA -->
    <div id="loginCard" class="login-card">
      <h1> Consulta de Calificaciones</h1>
      <p class="subtitle">Ingresa tu matr칤cula y correo para consultar tus calificaciones</p>

      <form id="formConsulta" onsubmit="consultarAlumno(event)">
        <div class="form-grupo">
          <label for="matricula">Matr칤cula:</label>
          <input type="text" id="matricula" required placeholder="Ej: 2024001" autocomplete="off">
        </div>

        <div class="form-grupo">
          <label for="email">Correo Electr칩nico:</label>
          <input type="email" id="email" required placeholder="tu-email@alumno.com" autocomplete="email">
        </div>

        <button type="submit" class="btn-consultar" id="btnConsultar">
           Consultar
        </button>
      </form>
    </div>

    <!-- RESULTADO -->
    <div id="resultado" class="resultado">
      <div class="info-alumno">
        <div class="info-header">
          <h2 id="nombreAlumno">Nombre del Alumno</h2>
          <div class="info-grid">
            <div class="info-item">
              <strong>Matr칤cula:</strong>
              <span id="infoMatricula">-</span>
            </div>
            <div class="info-item">
              <strong>Grupo:</strong>
              <span id="infoGrupo">-</span>
            </div>
            <div class="info-item">
              <strong>Carrera:</strong>
              <span id="infoCarrera">-</span>
            </div>
          </div>
        </div>

        <button onclick="nuevaConsulta()" class="btn-nuevo">游댃 Nueva Consulta</button>
        <button class="btn-horario" title="Pr칩ximamente">游뎷 Ver Horario (Pr칩ximamente)</button>
      </div>

      <!-- MATERIAS Y CALIFICACIONES -->
      <div class="seccion">
        <h3> Mis Materias</h3>
        <div id="listaMaterias"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <script>
    let alumnoActual = null;

    async function consultarAlumno(event) {
      event.preventDefault();
      
      const matricula = document.getElementById('matricula').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const btnConsultar = document.getElementById('btnConsultar');
      
      btnConsultar.disabled = true;
      btnConsultar.textContent = ' Consultando...';
      
      try {
        // Buscar alumno por matr칤cula y email
        const snapshot = await db.collection('usuarios')
          .where('rol', '==', 'alumno')
          .where('matricula', '==', matricula)
          .where('email', '==', email)
          .limit(1)
          .get();
        
        if (snapshot.empty) {
          alert(' No se encontr칩 ning칰n alumno con esa matr칤cula y correo.\n\nVerifica tus datos.');
          btnConsultar.disabled = false;
          btnConsultar.textContent = ' Consultar';
          return;
        }
        
        const doc = snapshot.docs[0];
        alumnoActual = {
          id: doc.id,
          ...doc.data()
        };
        
        // Mostrar informaci칩n
        await mostrarInformacionAlumno();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al consultar. Intenta de nuevo.');
        btnConsultar.disabled = false;
        btnConsultar.textContent = ' Consultar';
      }
    }

    async function mostrarInformacionAlumno() {
      // Mostrar nombre
      document.getElementById('nombreAlumno').textContent = alumnoActual.nombre;
      document.getElementById('infoMatricula').textContent = alumnoActual.matricula;
      
      // Cargar grupo
      if (alumnoActual.grupoId) {
        try {
          const grupoDoc = await db.collection('grupos').doc(alumnoActual.grupoId).get();
          if (grupoDoc.exists) {
            document.getElementById('infoGrupo').textContent = grupoDoc.data().nombre;
          }
        } catch (error) {
          console.error('Error al cargar grupo:', error);
        }
      } else {
        document.getElementById('infoGrupo').textContent = 'Sin grupo asignado';
      }
      
      // Cargar carrera
      if (alumnoActual.carreraId) {
        try {
          const carreraDoc = await db.collection('carreras').doc(alumnoActual.carreraId).get();
          if (carreraDoc.exists) {
            document.getElementById('infoCarrera').textContent = carreraDoc.data().nombre;
          }
        } catch (error) {
          console.error('Error al cargar carrera:', error);
        }
      }
      
      // Cargar materias y calificaciones
      await cargarMateriasYCalificaciones();
      
      // Mostrar resultado, ocultar formulario
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('resultado').style.display = 'block';
    }

    async function cargarMateriasYCalificaciones() {
      const container = document.getElementById('listaMaterias');
      
      if (!alumnoActual.grupoId) {
        container.innerHTML = '<div class="sin-datos">No est치s asignado a ning칰n grupo.</div>';
        return;
      }
      
      try {
        // Buscar materias asignadas al grupo
        const materiasSnap = await db.collection('profesorMaterias')
          .where('grupoId', '==', alumnoActual.grupoId)
          .where('activa', '==', true)
          .get();
        
        if (materiasSnap.empty) {
          container.innerHTML = '<div class="sin-datos">Tu grupo a칰n no tiene materias asignadas.</div>';
          return;
        }
        
        let html = '';
        
        for (const doc of materiasSnap.docs) {
          const materia = doc.data();
          
          // Buscar calificaciones de esta materia
          const calificacionesSnap = await db.collection('calificaciones')
            .where('alumnoId', '==', alumnoActual.id)
            .where('materiaId', '==', materia.materiaId)
            .get();
          
          html += `
            <div class="materia-card">
              <h4> ${materia.materiaNombre} (${materia.materiaCodigo})</h4>
              <div class="materia-info">
                <span>Profesor: ${materia.profesorNombre}</span> | 
                <span> Periodo: ${materia.periodo}</span>
              </div>
          `;
          
          if (calificacionesSnap.empty) {
            html += '<div class="sin-datos">A칰n no hay calificaciones registradas</div>';
          } else {
            html += '<div class="calificaciones-list">';
            html += '<strong> Calificaciones:</strong>';
            
            calificacionesSnap.forEach(calDoc => {
              const cal = calDoc.data();
              const fecha = cal.fecha ? cal.fecha.toDate().toLocaleDateString() : '-';
              
              html += `
                <div class="calificacion-item">
                  <div>
                    <strong>${cal.concepto || 'Evaluaci칩n'}</strong>
                    <br><small style="color: #999;">${fecha}</small>
                  </div>
                  <div class="calificacion-valor">${cal.calificacion}</div>
                </div>
              `;
            });
            
            html += '</div>';
          }
          
          html += '</div>';
        }
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="sin-datos" style="color: red;">Error al cargar informaci칩n</div>';
      }
    }

    function nuevaConsulta() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('formConsulta').reset();
      document.getElementById('btnConsultar').disabled = false;
      document.getElementById('btnConsultar').textContent = '游댌 Consultar';
      alumnoActual = null;
    }
  </script>
</body>
</html>