<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Calificaciones</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .login-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2rem;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }

    .form-grupo {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-consultar {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn-consultar:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-consultar:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .resultado {
      display: none;
    }

    .info-alumno {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .info-header {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .info-header h2 {
      margin: 0 0 10px 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
    }

    .info-item strong {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 3px;
    }

    .seccion {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .seccion h3 {
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
    }

    .materia-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .materia-card h4 {
      color: #333;
      margin: 0 0 10px 0;
    }

    .materia-info {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }

    .calificaciones-list {
      background: white;
      padding: 15px;
      border-radius: 8px;
    }

    .calificacion-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .calificacion-item:last-child {
      border-bottom: none;
    }

    .calificacion-valor {
      font-weight: bold;
      color: #4caf50;
      font-size: 1.2rem;
    }

    .sin-datos {
      text-align: center;
      padding: 30px;
      color: #999;
      font-style: italic;
    }

    .btn-nuevo {
      background: #f5f5f5;
      color: #667eea;
      border: 2px solid #667eea;
      padding: 12px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-block;
      text-align: center;
      margin-top: 20px;
    }

    .btn-nuevo:hover {
      background: #667eea;
      color: white;
    }

    .btn-horario {
      background: #e0e0e0;
      color: #666;
      padding: 12px 30px;
      border-radius: 10px;
      border: none;
      cursor: not-allowed;
      font-weight: 600;
      margin-top: 20px;
      display: inline-block;
    }

    /* Estilos para m√≥vil */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 0;
      }

      .login-card, .info-alumno, .seccion {
        padding: 20px 15px;
        margin-bottom: 15px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .info-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      /* Tabla responsive */
      .resultado table {
        font-size: 0.85rem;
      }

      .resultado th,
      .resultado td {
        padding: 8px !important;
        white-space: nowrap;
      }

      .btn-nuevo,
      .btn-horario {
        display: block;
        width: 100%;
        margin-top: 10px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.3rem;
      }

      .resultado table {
        font-size: 0.75rem;
      }

      .resultado th,
      .resultado td {
        padding: 6px !important;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- FORMULARIO DE CONSULTA -->
    <div id="loginCard" class="login-card">
      <h1>üë®‚Äçüéì Consulta de Calificaciones</h1>
      <p class="subtitle">Ingresa tu matr√≠cula y correo para consultar tus calificaciones</p>
      
      <!-- Bot√≥n logout solo si hay sesi√≥n activa -->
      <div id="sessionAlert" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <p style="margin: 0 0 10px 0; color: #856404;">
          ‚ö†Ô∏è Tienes una sesi√≥n activa. Los alumnos ya no necesitan iniciar sesi√≥n.
        </p>
        <button onclick="cerrarSesion()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
          üö™ Cerrar Sesi√≥n
        </button>
      </div>

      <form id="formConsulta" onsubmit="consultarAlumno(event)">
        <div class="form-grupo">
          <label for="matricula">Matr√≠cula:</label>
          <input type="text" id="matricula" required placeholder="Ej: 2024001" autocomplete="off">
        </div>

        <div class="form-grupo">
          <label for="email">Correo Electr√≥nico:</label>
          <input type="email" id="email" required placeholder="tu-email@alumno.com" autocomplete="email">
        </div>

        <button type="submit" class="btn-consultar" id="btnConsultar">
           Consultar
        </button>
      </form>
    </div>

    <!-- RESULTADO -->
    <div id="resultado" class="resultado">
      <div class="info-alumno">
        <div class="info-header">
          <h2 id="nombreAlumno">Nombre del Alumno</h2>
          <div class="info-grid">
            <div class="info-item">
              <strong>Matr√≠cula:</strong>
              <span id="infoMatricula">-</span>
            </div>
            <div class="info-item">
              <strong>Grupo:</strong>
              <span id="infoGrupo">-</span>
            </div>
            <div class="info-item">
              <strong>Carrera:</strong>
              <span id="infoCarrera">-</span>
            </div>
          </div>
        </div>

        <button onclick="nuevaConsulta()" class="btn-nuevo">üîÑ Nueva Consulta</button>
        <button class="btn-horario" title="Pr√≥ximamente">üïê Ver Horario (Pr√≥ximamente)</button>
      </div>

      <!-- MATERIAS Y CALIFICACIONES -->
      <div class="seccion">
        <h3> Mis Materias</h3>
        <div id="listaMaterias"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script>
    let alumnoActual = null;
    
    // Detectar si hay sesi√≥n activa
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // Hay sesi√≥n activa - mostrar alerta
        document.getElementById('sessionAlert').style.display = 'block';
      }
    });
    
    async function cerrarSesion() {
      try {
        await firebase.auth().signOut();
        alert('‚úÖ Sesi√≥n cerrada. Ahora puedes consultar como alumno o ir al login del staff.');
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cerrar sesi√≥n');
      }
    }

    async function consultarAlumno(event) {
      event.preventDefault();
      
      const matricula = document.getElementById('matricula').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const btnConsultar = document.getElementById('btnConsultar');
      
      btnConsultar.disabled = true;
      btnConsultar.textContent = ' Consultando...';
      
      try {
        // Buscar alumno por matr√≠cula y email
        const snapshot = await db.collection('usuarios')
          .where('rol', '==', 'alumno')
          .where('matricula', '==', matricula)
          .where('email', '==', email)
          .limit(1)
          .get();
        
        if (snapshot.empty) {
          alert(' No se encontr√≥ ning√∫n alumno con esa matr√≠cula y correo.\n\nVerifica tus datos.');
          btnConsultar.disabled = false;
          btnConsultar.textContent = ' Consultar';
          return;
        }
        
        const doc = snapshot.docs[0];
        alumnoActual = {
          id: doc.id,
          ...doc.data()
        };
        
        // Mostrar informaci√≥n
        await mostrarInformacionAlumno();
        
      } catch (error) {
        console.error('Error:', error);
        alert('Error al consultar. Intenta de nuevo.');
        btnConsultar.disabled = false;
        btnConsultar.textContent = ' Consultar';
      }
    }

    async function mostrarInformacionAlumno() {
      // Mostrar nombre
      document.getElementById('nombreAlumno').textContent = alumnoActual.nombre;
      document.getElementById('infoMatricula').textContent = alumnoActual.matricula;
      
      // Cargar grupo
      if (alumnoActual.grupoId) {
        try {
          const grupoDoc = await db.collection('grupos').doc(alumnoActual.grupoId).get();
          if (grupoDoc.exists) {
            document.getElementById('infoGrupo').textContent = grupoDoc.data().nombre;
          }
        } catch (error) {
          console.error('Error al cargar grupo:', error);
        }
      } else {
        document.getElementById('infoGrupo').textContent = 'Sin grupo asignado';
      }
      
      // Cargar carrera
      if (alumnoActual.carreraId) {
        try {
          const carreraDoc = await db.collection('carreras').doc(alumnoActual.carreraId).get();
          if (carreraDoc.exists) {
            document.getElementById('infoCarrera').textContent = carreraDoc.data().nombre;
          }
        } catch (error) {
          console.error('Error al cargar carrera:', error);
        }
      }
      
      // Cargar materias y calificaciones
      await cargarMateriasYCalificaciones();
      
      // Mostrar resultado, ocultar formulario
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('resultado').style.display = 'block';
    }

    async function cargarMateriasYCalificaciones() {
      const container = document.getElementById('listaMaterias');
      
      if (!alumnoActual.grupoId) {
        container.innerHTML = '<div class="sin-datos">No est√°s asignado a ning√∫n grupo.</div>';
        return;
      }
      
      try {
        // Buscar materias asignadas al grupo
        const materiasSnap = await db.collection('profesorMaterias')
          .where('grupoId', '==', alumnoActual.grupoId)
          .where('activa', '==', true)
          .get();
        
        if (materiasSnap.empty) {
          container.innerHTML = '<div class="sin-datos">Tu grupo a√∫n no tiene materias asignadas.</div>';
          return;
        }
        
        // Construir estructura de datos para boleta
        const materias = [];
        
        for (const doc of materiasSnap.docs) {
          const materia = doc.data();
          
          // Buscar calificaciones de esta materia (NUEVA ESTRUCTURA)
          const docId = `${alumnoActual.id}_${materia.materiaId}`;
          const calDoc = await db.collection('calificaciones').doc(docId).get();
          
          let parcial1 = '-';
          let parcial2 = '-';
          let parcial3 = '-';
          
          if (calDoc.exists) {
            const data = calDoc.data();
            parcial1 = data.parciales?.parcial1 ?? '-';
            parcial2 = data.parciales?.parcial2 ?? '-';
            parcial3 = data.parciales?.parcial3 ?? '-';
          }
          
          materias.push({
            nombre: materia.materiaNombre,
            codigo: materia.materiaCodigo,
            profesor: materia.profesorNombre,
            parcial1: parcial1,
            parcial2: parcial2,
            parcial3: parcial3
          });
        }
        
        // Generar tabla tipo boleta
        let html = `
          <div style="background: white; padding: 20px; border-radius: 10px;">
            <h3 style="color: #667eea; margin: 0 0 20px 0; text-align: center;">üìã Boleta de Calificaciones</h3>
            <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
              <table style="width: 100%; min-width: 600px; border-collapse: collapse;">
              <thead>
                <tr style="background: #667eea; color: white;">
                  <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Materia</th>
                  <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 90px; min-width: 90px;">Parcial 1</th>
                  <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 90px; min-width: 90px;">Parcial 2</th>
                  <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 90px; min-width: 90px;">Parcial 3</th>
                  <th style="padding: 12px; text-align: center; border: 1px solid #ddd; width: 90px; min-width: 90px;">Promedio</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        materias.forEach(materia => {
          // Calcular promedio (NP = 0, ignorar null/-)
          const cals = [materia.parcial1, materia.parcial2, materia.parcial3]
            .filter(c => c !== '-' && c !== null && c !== undefined)
            .map(c => c === 'NP' ? 0 : parseFloat(c))
            .filter(c => !isNaN(c));
          
          const promedio = cals.length > 0 
            ? (cals.reduce((a, b) => a + b, 0) / cals.length).toFixed(1)
            : '-';
          
          html += `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 12px; border: 1px solid #ddd;">
                <strong>${materia.nombre}</strong>
                <br><small style="color: #666;">üë®‚Äçüè´ ${materia.profesor}</small>
              </td>
              <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 1.2rem; font-weight: bold; color: ${materia.parcial1 === 'NP' ? '#ff9800' : (materia.parcial1 !== '-' ? '#4caf50' : '#999')};">
                ${materia.parcial1}
              </td>
              <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 1.2rem; font-weight: bold; color: ${materia.parcial2 === 'NP' ? '#ff9800' : (materia.parcial2 !== '-' ? '#4caf50' : '#999')};">
                ${materia.parcial2}
              </td>
              <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 1.2rem; font-weight: bold; color: ${materia.parcial3 === 'NP' ? '#ff9800' : (materia.parcial3 !== '-' ? '#4caf50' : '#999')};">
                ${materia.parcial3}
              </td>
              <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 1.3rem; font-weight: bold; background: #f0f7ff; color: #667eea;">
                ${promedio}
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
              </table>
            </div>
            <p style="text-align: center; color: #999; font-size: 0.85rem; margin-top: 10px;">
              üí° Desliza horizontalmente para ver todas las columnas
            </p>
          </div>
        `;
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="sin-datos" style="color: red;">Error al cargar informaci√≥n</div>';
      }
    }

    function nuevaConsulta() {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('formConsulta').reset();
      document.getElementById('btnConsultar').disabled = false;
      document.getElementById('btnConsultar').textContent = 'üîç Consultar';
      alumnoActual = null;
    }
  </script>
</body>
</html>